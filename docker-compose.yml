services:
  mosquitto:
    image: eclipse-mosquitto:${MOSQUITTO_VERSION:-latest}
    user: "root" # Start as root to initialize files, then drop privileges in entrypoint
    container_name: mosquitto
    restart: unless-stopped
    environment:
      - TZ=${TZ:-UTC}
      - MQTT_USER=${MQTT_USERNAME}
      - MQTT_PASSWORD=${MQTT_PASSWORD}
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    # Expose ports for local development/debugging.
    # Comment these out in production if you only want access via Cloudflare Tunnel.
    ports:
      - "${MQTT_PORT:-1883}:1883"     # MQTT Default Port
      - "${MQTT_WS_PORT:-8083}:8083"  # MQTT WebSockets Port
    entrypoint: >
      sh -c "
        chown -R mosquitto:mosquitto /mosquitto/config /mosquitto/data /mosquitto/log;

        PW_FILE=/mosquitto/config/pwfile;
        if [ ! -f $$PW_FILE ]; then
          echo 'Initializing password file...'
          touch $$PW_FILE
          mosquitto_passwd -b $$PW_FILE $$MQTT_USER $$MQTT_PASSWORD
        fi;
        chmod 0700 $$PW_FILE;

        exec /usr/sbin/mosquitto -c /mosquitto/config/mosquitto.conf
      "
    networks:
      - example_network

  cloudflared:
    image: cloudflare/cloudflared:${CLOUDFLARED_VERSION:-latest}
    container_name: cloudflared
    restart: unless-stopped
    environment:
      - TUNNEL_TOKEN=${CF_TUNNEL_TOKEN}
      - TZ=${TZ:-UTC}
    command: tunnel --no-autoupdate run
    # Use this to force HTTP/2, which is more likely to work in restrictive environments
    # command: tunnel --no-autoupdate run --protocol http2
    networks:
      - example_network
    depends_on:
      - mosquitto

networks:
  example_network:
    driver: bridge
  